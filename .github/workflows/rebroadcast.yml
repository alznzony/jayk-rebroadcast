name: Rebroadcast Pending Orders

on:
  workflow_dispatch:
  schedule:
    - cron: "*/1 * * * *"

jobs:
  rebroadcast:
    runs-on: ubuntu-latest

    steps:
      - name: Call Supabase Re-Broadcast Function
        run: |
          echo "Calling Re-Broadcast Function..."

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SERVICE_ROLE }}" \
            -d '{}' \
            https://gxnokzufjkioldjfgowk.supabase.co/functions/v1/rebroadcast_pending_orders)

          BODY=$(echo "$RESPONSE" | sed '$d')
          STATUS=$(echo "$RESPONSE" | tail -n1)

          echo "HTTP Status = $STATUS"
          echo "--- Response ---"
          echo "$BODY"

          if [ "$STATUS" -ne 200 ]; then
            echo "ERROR: Function failed"
            exit 1
          fi
